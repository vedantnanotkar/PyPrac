<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal Login</title>
    <!-- 1. Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Set a default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 3. Utility classes to show/hide views */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md">
        <!-- 
          View 1: Login Page
        -->
        <div id="login-view" class="view active">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h1 class="text-2xl font-bold text-center mb-6">PyPrac Login</h1>
                <form id="login-form">
                    <div class="mb-6">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="you@example.com">
                    </div>

                    <!-- *** The Phone Number field has been removed *** -->

                    <button type="submit" id="login-button"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                        <span id="login-button-text">Login</span>
                        <div id="loading-spinner" class="spinner ml-3 hidden"></div>
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
            </div>
        </div>

        <!-- 
          View 2: Dashboard Page
        -->
        <div id="dashboard-view" class="view">
            <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                <h1 class="text-3xl font-bold mb-4">
                    Welcome, <span id="user-name" class="text-blue-600"></span>!
                </h1>
                <p class="text-gray-700 mb-6">You have successfully logged into your PyPrac Account.</p>
                <a href="/PyPrac/index.html">
                    <button class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                        Go to Home
                    </button>
                </a>
                <br>
                <button id="logout-button"
                        class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-300">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- 
      4. Firebase SDKs
    -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 5. Firebase Configuration ---
        
        // !!!!!!!!!!!!!!!!!! IMPORTANT !!!!!!!!!!!!!!!!!!
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE
        const userFirebaseConfig = {
          apiKey: "AIzaSyC_UbgR14NfW8IzuoBUqTgKfpX1w5Rfua4",
          authDomain: "pyprac-collage.firebaseapp.com",
          databaseURL: "https://pyprac-collage-default-rtdb.firebaseio.com",
          projectId: "pyprac-collage",
          storageBucket: "pyprac-collage.firebasestorage.app",
          messagingSenderId: "819525843051",
          appId: "1:819525843051:web:640a5bde511fca7568592e"
        };
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        const injectedConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const firebaseConfig = (injectedConfig && injectedConfig.apiKey) 
            ? injectedConfig 
            : userFirebaseConfig;

        let db, auth;
        let isAuthReady = false;

        // --- 6. DOM Element References ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        // *** No more phoneInput ***
        const loginError = document.getElementById('login-error');
        const userName = document.getElementById('user-name');
        const logoutButton = document.getElementById('logout-button');
        const loginButtonText = document.getElementById('login-button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginButton = document.getElementById('login-button');

        // Utility function to switch between views
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        // --- 7. Initialize Firebase and Auth ---
        async function initializeFirebase() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                loginError.textContent = "Please paste your Firebase config in the HTML file.";
                console.error("Firebase config is missing.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Firebase Auth user signed in:", user.uid);
                        isAuthReady = true;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Error signing in:", authError);
                            loginError.textContent = "Error initializing auth. Please refresh.";
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                loginError.textContent = "Could not connect to Firebase. Check config.";
            }
        }

        // --- 8. Login Form Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || !db) {
                loginError.textContent = "Connecting... Please try again in a moment.";
                return;
            }

            const email = emailInput.value.trim();
            // *** No more phone variable ***

            loginError.textContent = "";
            loginButtonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            loginButton.disabled = true;

            try {
                const studentsRef = collection(db, "PyPrac_Students");
                
                // *** Query is now much simpler: just email ***
                const q = query(studentsRef, 
                    where("email", "==", email)
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // *** Updated error message ***
                    loginError.textContent = "Invalid email address. Please try again.";
                } else {
                    // Match found!
                    const userData = querySnapshot.docs[0].data();
                    
                    // *** NEW: Save user to localStorage ***
                    localStorage.setItem('studentUser', JSON.stringify(userData));

                    userName.textContent = userData.firstName || 'Student'; // Fallback
                    
                    showView('dashboard-view');
                }

            } catch (error) {
                console.error("Error querying Firestore:", error);
                loginError.textContent = "An error occurred. Please check console for details.";
            } finally {
                loginButtonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                loginButton.disabled = false;
            }
        });

        // --- 9. Logout Button Logic ---
        logoutButton.addEventListener('click', () => {

            // *** NEW: Remove user from localStorage ***
            localStorage.removeItem('studentUser');

            userName.textContent = "";
            emailInput.value = "";
            // *** No more phoneInput to clear ***
            loginError.textContent = "";

            showView('login-view');
        });

        // *** NEW: Function to check for a saved user on page load ***
        function checkPersistentLogin() {
            const savedUserString = localStorage.getItem('studentUser');
            
            if (savedUserString) {
                try {
                    const userData = JSON.parse(savedUserString);
                    userName.textContent = userData.firstName || 'Student';
                    // If user is found, go straight to dashboard
                    showView('dashboard-view');
                } catch (e) {
                    // If JSON is corrupt, clear it and show login
                    console.error("Error parsing saved user data:", e);
                    localStorage.removeItem('studentUser');
                    showView('login-view');
                }
            } else {
                // No user saved, show the login page
                showView('login-view');
            }
        }

        // First, initialize Firebase (this runs in the background)
        initializeFirebase();
        
        // Then, immediately check our persistent state
        checkPersistentLogin();

    </script>
</body>
</html>